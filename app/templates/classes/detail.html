<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/classes" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">{{.class.Name}}</h1>
                        <p class="text-sm text-gray-500">
                            {{if .class.Teacher}}
                                Class Teacher: {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                                Class Teacher: Not assigned
                            {{end}}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="addSubjectsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add Subjects
                    </button>
                    <button id="editClassBtn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Edit Class
                    </button>
                    <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Students</p>
                        <p id="totalStudents" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Male Students</p>
                        <p id="maleStudents" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Female Students</p>
                        <p id="femaleStudents" class="text-2xl font-bold text-pink-600">-</p>
                    </div>
                    <div class="bg-pink-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Class Teacher</p>
                        <p id="classTeacher" class="text-sm font-medium text-gray-900">
                            {{if .class.Teacher}}
                                {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                            {{else}}
                                Not assigned
                            {{end}}
                        </p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Section -->
        <div class="mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Class Subjects</h2>
                        <button id="addSubjectsBtn2" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors duration-200">
                            Add Subjects
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Skeleton Loading -->
                    <div id="subjectsLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="animate-pulse bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                                </div>
                                <div class="w-4 h-4 bg-gray-300 rounded"></div>
                            </div>
                        </div>
                        <div class="animate-pulse bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                                </div>
                                <div class="w-4 h-4 bg-gray-300 rounded"></div>
                            </div>
                        </div>
                    </div>
                    <div id="subjectsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" style="display: none;">
                        <!-- Subjects will be loaded here -->
                    </div>
                    <div id="noSubjects" class="text-center py-8 text-gray-500" style="display: none;">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <p>No subjects assigned to this class yet.</p>
                        <button onclick="openSubjectsModal()" class="mt-2 text-green-600 hover:text-green-700 font-medium">Add subjects to get started</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Students List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Students</h2>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <input type="text" id="searchStudents" placeholder="Search students..." 
                                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Loading skeleton -->
                                <tr class="skeleton-row">
                                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                        <div class="flex items-center justify-center">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                                            <span class="ml-2">Loading students...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Class Settings Sidebar -->
            <div class="space-y-6">
                <!-- Promotion Settings -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Promotion Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Promote to Class</label>
                            <select id="promotionClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">Select target class...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Attendance (%)</label>
                            <input type="number" id="minAttendance" min="0" max="100" value="75" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Grade</label>
                            <select id="minGrade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="D">D</option>
                                <option value="C" selected>C</option>
                                <option value="B">B</option>
                                <option value="A">A</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="autoPromote" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label for="autoPromote" class="ml-2 block text-sm text-gray-900">Auto-promote eligible students</label>
                        </div>
                        
                        <button id="savePromotionSettings" class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                            Save Settings
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    
                    <div class="space-y-3">
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                View Attendance Report
                            </div>
                        </button>
                        
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 00-2-2z"/>
                                </svg>
                                Performance Analytics
                            </div>
                        </button>
                        
                        <button class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Export Student List
                            </div>
                        </button>
                        
                        <button id="promoteStudentsBtn" class="w-full text-left px-4 py-3 text-sm text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors duration-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                Promote Students
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div id="studentModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-900">Student Details</h2>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div id="studentModalContent">
            <!-- Student details will be loaded here -->
        </div>
    </div>
</div>

<!-- Subjects Modal -->
<div id="subjectsModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900">Add Subjects to Class</h2>
            <button onclick="closeSubjectsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="mb-4">
            <p class="text-sm text-gray-600">Select subjects to add to this class:</p>
        </div>
        <div id="availableSubjects" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
            <!-- Loading skeleton -->
            <div id="subjectsLoading" class="space-y-2">
                <div class="animate-pulse flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-4 h-4 bg-gray-300 rounded"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
                <div class="animate-pulse flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-4 h-4 bg-gray-300 rounded"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                        <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                    </div>
                </div>
                <div class="animate-pulse flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-4 h-4 bg-gray-300 rounded"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded w-4/5 mb-2"></div>
                        <div class="h-3 bg-gray-300 rounded w-2/5"></div>
                    </div>
                </div>
            </div>
            <!-- Available subjects will be loaded here -->
        </div>
        <div id="selectedPapers" class="mb-4" style="display: none;">
            <h4 class="font-medium text-gray-900 mb-2">Select Papers for Selected Subjects:</h4>
            <div id="papersContainer" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                <!-- Papers will be loaded here -->
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeSubjectsModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </button>
            <button onclick="addSelectedSubjects()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Add Subject
            </button>
        </div>
    </div>
</div>

<!-- Subject Papers Modal -->
<div id="subjectPapersModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="subjectPapersTitle" class="text-xl font-bold text-gray-900">Subject Papers</h2>
            <button onclick="closeSubjectPapersModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="subjectPapersContent" class="space-y-3">
            <!-- Papers will be loaded here -->
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button onclick="closeSubjectPapersModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Close
            </button>
            <button id="savePapersBtn" onclick="saveSubjectPapers()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                <span id="saveBtnText">Save Changes</span>
                <svg id="saveBtnSpinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Teacher Selection Modal -->
<div id="teacherModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Select Teacher</h3>
            <button onclick="closeTeacherModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="teachersList" class="space-y-2 max-h-60 overflow-y-auto">
            <!-- Teachers will be loaded here -->
        </div>
        <div class="flex justify-end space-x-3 mt-4">
            <button onclick="closeTeacherModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                Cancel
            </button>
            <button onclick="clearTeacher()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Clear
            </button>
        </div>
    </div>
</div>

<script>
    const classID = '{{.classID}}';
    let classData = {
        students: [],
        statistics: {},
        promotionSettings: null,
        availableClasses: []
    };

    // Load class details on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Class detail page loaded for class:', classID);
        loadClassDetails();
        
        const closeModal = document.getElementById('closeModal');
        const studentModal = document.getElementById('studentModal');
        closeModal.addEventListener('click', () => {
            studentModal.classList.add('hidden');
        });
    });

    // Load detailed class information
    async function loadClassDetails() {
        try {
            const response = await fetch(`/api/classes/${classID}/details`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                classData = result;
                updateStatistics(result.statistics);
                displayStudents(result.students);
                loadPromotionSettings(result.promotion_settings, result.available_promotion_classes);
            }
        } catch (error) {
            console.error('Error loading class details:', error);
            showErrorState();
        }
    }

    // Update statistics display
    function updateStatistics(stats) {
        document.getElementById('totalStudents').textContent = stats.total_students || 0;
        document.getElementById('maleStudents').textContent = stats.male_students || 0;
        document.getElementById('femaleStudents').textContent = stats.female_students || 0;
    }

    // Display students in table
    function displayStudents(students) {
        const tableBody = document.getElementById('studentsTableBody');
        
        if (students.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                            <p class="text-lg font-medium text-gray-900 mb-1">No students found</p>
                            <p class="text-sm text-gray-500">Add students to this class to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = students.map(student => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-primary-600 font-medium text-sm">${student.first_name.charAt(0)}${student.last_name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${student.first_name} ${student.last_name}</p>
                            <p class="text-xs text-gray-500">${student.email || 'No email'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">${student.student_id}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        student.gender === 'male' ? 'bg-blue-100 text-blue-800' : 
                        student.gender === 'female' ? 'bg-pink-100 text-pink-800' : 
                        'bg-gray-100 text-gray-800'
                    }">
                        ${student.gender ? student.gender.charAt(0).toUpperCase() + student.gender.slice(1) : 'Not specified'}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <button onclick="viewStudent('${student.id}')" class="text-primary-600 hover:text-primary-800 text-sm font-medium">View</button>
                        <button onclick="removeStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function showErrorState() {
        const tableBody = document.getElementById('studentsTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-lg font-medium text-gray-900 mb-1">Error loading class details</p>
                        <p class="text-sm text-gray-500">Please try refreshing the page</p>
                    </div>
                </td>
            </tr>
        `;
    }

    // Load promotion settings
    function loadPromotionSettings(promotionSettings, availableClasses) {
        const promotionClassSelect = document.getElementById('promotionClass');

        // Populate available classes
        promotionClassSelect.innerHTML = '<option value="">Select target class...</option>';
        availableClasses.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.name;
            promotionClassSelect.appendChild(option);
        });

        // Load existing settings if available
        if (promotionSettings) {
            promotionClassSelect.value = promotionSettings.to_class_id;

            // Parse promotion criteria if it exists
            if (promotionSettings.promotion_criteria) {
                try {
                    const criteria = JSON.parse(promotionSettings.promotion_criteria);
                    document.getElementById('minAttendance').value = criteria.minimum_attendance || 75;
                    document.getElementById('minGrade').value = criteria.minimum_grade || 'C';
                    document.getElementById('autoPromote').checked = criteria.auto_promote || false;
                } catch (e) {
                    console.error('Error parsing promotion criteria:', e);
                }
            }
        }
    }

    // Save promotion settings
    document.getElementById('savePromotionSettings').addEventListener('click', async function() {
        const promotionClassId = document.getElementById('promotionClass').value;
        const minAttendance = document.getElementById('minAttendance').value;
        const minGrade = document.getElementById('minGrade').value;
        const autoPromote = document.getElementById('autoPromote').checked;

        if (!promotionClassId) {
            alert('Please select a target class for promotion');
            return;
        }

        const criteria = {
            minimum_attendance: parseFloat(minAttendance),
            minimum_grade: minGrade,
            auto_promote: autoPromote,
            required_subjects: [] // Can be expanded later
        };

        try {
            const response = await fetch(`/api/classes/${classID}/promotion`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    to_class_id: promotionClassId,
                    promotion_criteria: JSON.stringify(criteria)
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // Show success message
                showNotification('Promotion settings saved successfully!', 'success');
            } else {
                throw new Error(result.error || 'Failed to save promotion settings');
            }
        } catch (error) {
            console.error('Error saving promotion settings:', error);
            showNotification('Error saving promotion settings: ' + error.message, 'error');
        }
    });

    // Student actions
    async function viewStudent(studentId) {
        const studentModal = document.getElementById('studentModal');
        const studentModalContent = document.getElementById('studentModalContent');
        studentModalContent.innerHTML = '<p>Loading...</p>';
        studentModal.classList.remove('hidden');

        try {
            const response = await fetch(`/api/students/${studentId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch student details');
            }
            const data = await response.json();
            const student = data.student;
            const parent = data.parent;

            let parentInfo = '<p>No parent information available.</p>';
            if (parent) {
                parentInfo = `
                    <h4 class="text-lg font-semibold mt-4">Parent Information</h4>
                    <p><strong>Name:</strong> ${parent.first_name} ${parent.last_name}</p>
                    <p><strong>Email:</strong> ${parent.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${parent.phone || 'N/A'}</p>
                    <p><strong>Relationship:</strong> ${parent.relationship || 'N/A'}</p>
                `;
            }

            studentModalContent.innerHTML = `
                <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                <p><strong>Student ID:</strong> ${student.student_id}</p>
                <p><strong>Date of Birth:</strong> ${student.date_of_birth ? new Date(student.date_of_birth).toLocaleDateString() : 'N/A'}</p>
                <p><strong>Gender:</strong> ${student.gender || 'N/A'}</p>
                <p><strong>Address:</strong> ${student.address || 'N/A'}</p>
                ${parentInfo}
            `;
        } catch (error) {
            studentModalContent.innerHTML = '<p class="text-red-500">Failed to load student details.</p>';
            console.error('Error fetching student details:', error);
        }
    }

    function removeStudent(studentId) {
        if (confirm('Are you sure you want to remove this student from the class?')) {
            // TODO: Implement remove student API call
            console.log('Remove student:', studentId);
        }
    }

    // Search functionality
    document.getElementById('searchStudents').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#studentsTableBody tr');

        rows.forEach(row => {
            const studentName = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            const studentId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

            if (studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Subjects functionality
    let availableSubjects = [];

    async function loadClassSubjects() {
        console.log('Loading class subjects...');
        try {
            const response = await fetch(`/api/classes/{{.classID}}/subjects`);
            console.log('Subjects response status:', response.status);
            if (response.ok) {
                const subjects = await response.json();
                console.log('Subjects data:', subjects);
                console.log('Subjects length:', subjects.length);
                await displaySubjects(subjects);
            } else {
                console.error('Failed to load subjects, status:', response.status);
                const text = await response.text();
                console.error('Response text:', text.substring(0, 200));
                // Show error state
                document.getElementById('subjectsLoading').style.display = 'none';
                document.getElementById('noSubjects').style.display = 'block';
                document.getElementById('noSubjects').innerHTML = '<p class="text-red-500">Failed to load subjects</p>';
            }
        } catch (error) {
            console.error('Error loading subjects:', error);
            // Show error state
            document.getElementById('subjectsLoading').style.display = 'none';
            document.getElementById('noSubjects').style.display = 'block';
            document.getElementById('noSubjects').innerHTML = '<p class="text-red-500">Error loading subjects</p>';
        }
    }

    async function displaySubjects(subjects) {
        const container = document.getElementById('subjectsContainer');
        const noSubjects = document.getElementById('noSubjects');
        const loading = document.getElementById('subjectsLoading');

        // Hide loading
        loading.style.display = 'none';

        if (!subjects || subjects.length === 0) {
            container.style.display = 'none';
            noSubjects.style.display = 'block';
        } else {
            container.style.display = 'grid';
            noSubjects.style.display = 'none';
            
            container.innerHTML = subjects.map(subject => {
                const papers = subject.papers || [];
                return `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 cursor-pointer" onclick="openSubjectPapersModal('${subject.id}', '${subject.name}')">
                            <h4 class="font-medium text-gray-900">${subject.name}</h4>
                            <p class="text-sm text-gray-600">${subject.code}</p>
                            ${papers.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-xs text-gray-500 mb-1">Papers:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${papers.map(paper => `
                                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${paper.code}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="removeSubject('${subject.id}')" class="text-red-600 hover:text-red-800 ml-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
    }

    async function openSubjectsModal() {
        document.getElementById('subjectsModal').style.display = 'flex';
        document.getElementById('subjectsLoading').style.display = 'block';
        
        try {
            const response = await fetch('/api/subjects');
            if (response.ok) {
                const data = await response.json();
                availableSubjects = data.subjects || [];
                displayAvailableSubjects();
            }
        } catch (error) {
            console.error('Error loading subjects:', error);
            document.getElementById('subjectsLoading').innerHTML = '<p class="text-red-500 p-3">Failed to load subjects</p>';
        }
    }

    function displayAvailableSubjects() {
        const container = document.getElementById('availableSubjects');
        const loading = document.getElementById('subjectsLoading');
        
        loading.style.display = 'none';
        container.innerHTML = availableSubjects.map(subject => `
            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                <input type="radio" name="subject" value="${subject.id}" class="subject-radio" onchange="handleSubjectSelection()">
                <div>
                    <div class="font-medium text-gray-900">${subject.name}</div>
                    <div class="text-sm text-gray-600">${subject.code}</div>
                </div>
            </label>
        `).join('');
    }

    async function handleSubjectSelection() {
        const selectedSubject = document.querySelector('.subject-radio:checked')?.value;
        const papersSection = document.getElementById('selectedPapers');
        
        if (selectedSubject) {
            papersSection.style.display = 'block';
            await loadPapersForSubjects([selectedSubject]);
        } else {
            papersSection.style.display = 'none';
        }
    }

    async function loadPapersForSubjects(subjectIds) {
        const container = document.getElementById('papersContainer');
        container.innerHTML = '<div class="text-sm text-gray-500">Loading papers...</div>';
        
        try {
            const papers = [];
            for (const subjectId of subjectIds) {
                const response = await fetch(`/api/papers/by-subject/${subjectId}`);
                if (response.ok) {
                    const data = await response.json();
                    papers.push(...(data.papers || []));
                }
            }
            
            if (papers.length > 0) {
                container.innerHTML = papers.map(paper => `
                    <label class="flex items-center space-x-2 text-sm">
                        <input type="checkbox" value="${paper.id}" class="paper-checkbox">
                        <span>${paper.code}</span>
                    </label>
                `).join('');
            } else {
                container.innerHTML = '<div class="text-sm text-gray-500">No papers available for selected subjects</div>';
            }
        } catch (error) {
            container.innerHTML = '<div class="text-sm text-red-500">Failed to load papers</div>';
        }
    }

    async function addSelectedSubjects() {
        const selectedSubject = document.querySelector('.subject-radio:checked')?.value;
        
        if (!selectedSubject) {
            alert('Please select a subject');
            return;
        }

        try {
            const response = await fetch(`/api/classes/{{.classID}}/subjects`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    subject_ids: [selectedSubject]
                })
            });

            if (response.ok) {
                showNotification('Subject added successfully', 'success');
                closeSubjectsModal();
                loadClassSubjects();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to add subject'));
            }
        } catch (error) {
            console.error('Error adding subject:', error);
            alert('Error: Failed to add subject');
        }
    }

    // Subject Papers Modal Functions
    let currentSubjectId = null;
    let classPapersCache = [];

    async function openSubjectPapersModal(subjectId, subjectName) {
        currentSubjectId = subjectId;
        document.getElementById('subjectPapersTitle').textContent = `${subjectName} Papers`;
        document.getElementById('subjectPapersModal').classList.remove('hidden');
        
        // Load all papers for this subject and class papers
        await loadSubjectPapers(subjectId);
    }

    function closeSubjectPapersModal() {
        document.getElementById('subjectPapersModal').classList.add('hidden');
        currentSubjectId = null;
    }

    async function loadSubjectPapers(subjectId) {
        const content = document.getElementById('subjectPapersContent');
        content.innerHTML = '<div class="text-center text-gray-500">Loading papers...</div>';
        
        try {
            // Load all papers for the subject
            const subjectResponse = await fetch(`/api/papers/by-subject/${subjectId}`);
            if (!subjectResponse.ok) {
                throw new Error('Failed to load papers');
            }
            const subjectData = await subjectResponse.json();
            const allPapers = subjectData.papers || [];
            
            // Load class papers
            const classResponse = await fetch(`/api/classes/{{.classID}}/papers`);
            classPapersCache = classResponse.ok ? await classResponse.json() : [];
            
            // Load teachers
            const teachersResponse = await fetch('/api/teachers');
            const teachersData = await teachersResponse.json();
            const teachers = teachersData.teachers || [];
            
            // Get assigned paper IDs for this subject
            const assignedPaperIds = classPapersCache
                .filter(p => p.subject_id === subjectId)
                .map(p => p.id);
            
            if (allPapers.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-500">No papers available for this subject</div>';
                return;
            }
            
            content.innerHTML = allPapers.map(paper => {
                const assignedPaper = classPapersCache.find(cp => cp.id === paper.id);
                const assignedTeacher = assignedPaper && teachers.find(t => t.id === assignedPaper.teacher_id);
                return `
                <div class="border border-gray-200 rounded-lg p-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" value="${paper.id}" class="paper-assignment-checkbox" 
                               ${assignedPaper ? 'checked' : ''}>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${paper.code}</div>
                        </div>
                    </label>
                    <div class="mt-2 ml-6">
                        <label class="block text-xs text-gray-600 mb-1">Teacher:</label>
                        <button type="button" onclick="openTeacherModal('${paper.id}')" 
                                class="teacher-btn w-full text-left text-sm border border-gray-300 rounded px-2 py-1 hover:bg-gray-50" 
                                data-paper-id="${paper.id}" data-teacher-id="${assignedPaper ? assignedPaper.teacher_id || '' : ''}">
                            ${assignedTeacher ? `${assignedTeacher.first_name} ${assignedTeacher.last_name}` : 'Select Teacher'}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
        } catch (error) {
            content.innerHTML = '<div class="text-center text-red-500">Failed to load papers</div>';
        }
    }

    // Teacher Selection Modal
    let currentPaperId = null;
    let allTeachers = [];

    async function openTeacherModal(paperId) {
        currentPaperId = paperId;
        document.getElementById('teacherModal').classList.remove('hidden');
        
        if (allTeachers.length === 0) {
            try {
                const response = await fetch('/api/teachers');
                const data = await response.json();
                allTeachers = data.teachers || [];
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }
        
        const teachersList = document.getElementById('teachersList');
        teachersList.innerHTML = allTeachers.map(teacher => `
            <button onclick="selectTeacher('${teacher.id}', '${teacher.first_name} ${teacher.last_name}')" 
                    class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                <div class="font-medium">${teacher.first_name} ${teacher.last_name}</div>
                <div class="text-sm text-gray-600">${teacher.email}</div>
            </button>
        `).join('');
    }

    function closeTeacherModal() {
        document.getElementById('teacherModal').classList.add('hidden');
        currentPaperId = null;
    }

    function selectTeacher(teacherId, teacherName) {
        if (currentPaperId) {
            const btn = document.querySelector(`[data-paper-id="${currentPaperId}"]`);
            if (btn) {
                btn.textContent = teacherName;
                btn.setAttribute('data-teacher-id', teacherId);
            }
        }
        closeTeacherModal();
    }

    function clearTeacher() {
        if (currentPaperId) {
            const btn = document.querySelector(`[data-paper-id="${currentPaperId}"]`);
            if (btn) {
                btn.textContent = 'Select Teacher';
                btn.setAttribute('data-teacher-id', '');
            }
        }
        closeTeacherModal();
    }

    async function saveSubjectPapers() {
        if (!currentSubjectId) return;
        
        // Show loading state
        const btn = document.getElementById('savePapersBtn');
        const btnText = document.getElementById('saveBtnText');
        const spinner = document.getElementById('saveBtnSpinner');
        
        btn.disabled = true;
        btnText.textContent = 'Saving...';
        spinner.classList.remove('hidden');
        
        const checkboxes = document.querySelectorAll('.paper-assignment-checkbox');
        const paperAssignments = [];
        
        checkboxes.forEach(cb => {
            if (cb.checked) {
                const teacherBtn = document.querySelector(`[data-paper-id="${cb.value}"]`);
                const teacherId = teacherBtn ? teacherBtn.getAttribute('data-teacher-id') : '';
                paperAssignments.push({
                    paper_id: cb.value,
                    teacher_id: teacherId || null
                });
            }
        });
        
        try {
            const response = await fetch(`/api/classes/{{.classID}}/papers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    subject_id: currentSubjectId,
                    paper_assignments: paperAssignments
                })
            });
            
            if (response.ok) {
                showNotification('Papers updated successfully', 'success');
                closeSubjectPapersModal();
                await loadClassSubjects(); // Refresh the display
            } else {
                showNotification('Failed to update papers', 'error');
            }
        } catch (error) {
            showNotification('Error updating papers', 'error');
        } finally {
            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Save Changes';
            spinner.classList.add('hidden');
        }
    }

    async function removeSubject(subjectId) {
        if (!confirm('Are you sure you want to remove this subject from the class?')) return;

        try {
            const response = await fetch(`/api/classes/{{.classID}}/subjects/${subjectId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Subject removed successfully', 'success');
                loadClassSubjects();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to remove subject'));
            }
        } catch (error) {
            console.error('Error removing subject:', error);
            alert('Error: Failed to remove subject');
        }
    }

    function closeSubjectsModal() {
        document.getElementById('subjectsModal').style.display = 'none';
    }

    // Event listeners
    document.getElementById('addSubjectsBtn').addEventListener('click', openSubjectsModal);
    document.getElementById('addSubjectsBtn2').addEventListener('click', openSubjectsModal);

    // Load subjects on page load
    loadClassSubjects();
</script>
