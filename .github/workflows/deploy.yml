name: ğŸš€ Deploy Go App to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ğŸ› ï¸ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸš€ Deploy to Server (Password SSH)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}

        script: |
          set -e

          echo "ğŸ“‚ Moving to home directory..."
          cd ~

          echo "ğŸ›‘ Stopping existing app..."
          pkill -f "./main" >/dev/null 2>&1 || true

          echo "ğŸ“¥ Pulling latest code..."
          if [ -d "swadiq-schools" ]; then
            cd swadiq-schools
            git pull origin main
          else
            git clone https://github.com/ImaadDean/swadiq-schools.git
            cd swadiq-schools
          fi

          echo "ğŸ“¦ Installing Go modules..."
          go mod tidy

          echo "ğŸ”¨ Building app..."
          go build -o main .

          echo "ğŸš€ Starting app..."
          nohup ./main > app.log 2>&1 &
          sleep 3

          echo "âœ… Checking status..."
          if pgrep -f "./main" > /dev/null; then
            echo "âœ… Deployment successful! ğŸ‰"
          else
            echo "âŒ Failed to start the app!"
            echo "ğŸ‘‡ Last 10 log lines:"
            tail -10 app.log
            exit 1
          fi
