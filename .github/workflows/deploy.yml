name: ğŸš€ Deploy Go App to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ğŸ› ï¸ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸš€ Deploy to Server via SSH (Password)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        timeout: 1200s
        script: |
          set -e

          echo "ğŸ“‚ Moving to home directory..."
          cd ~

          echo "ğŸ›‘ Stopping existing application (if running)..."
          pkill -f "./main" >/dev/null 2>&1 || true

          echo "ğŸ“¥ Updating project..."
          if [ -d "swadiq-schools" ]; then
            cd swadiq-schools
            git pull origin main
          else
            git clone https://github.com/ImaadDean/swadiq-schools.git
            cd swadiq-schools
          fi

          echo "ğŸ“¦ Installing Go dependencies..."
          go mod tidy

          echo "ğŸ”¨ Building Go binary..."
          go build -o main .

          echo "ğŸš€ Starting Go app..."
          nohup ./main > app.log 2>&1 &
          disown

          echo "â³ Waiting 3 seconds for app to start..."
          sleep 3

          echo "âœ… Verifying application is running..."
          if pgrep -f "./main" > /dev/null; then
            echo "ğŸ‰ Deployment successful"
            echo "âœ… App is running"
          else
            echo "âŒ App failed to start"
            echo "ğŸ“„ Last logs:"
            tail -20 app.log
            exit 1
          fi
