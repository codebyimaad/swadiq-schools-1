<div class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="/attendance" class="inline-flex items-center text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Attendance
            </a>
            <div class="h-6 border-l border-gray-300"></div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{.class.Name}}</h1>
                <p class="text-gray-600 mt-1">
                    {{if .class.Teacher}}
                        Teacher: {{.class.Teacher.FirstName}} {{.class.Teacher.LastName}}
                    {{else}}
                        No teacher assigned
                    {{end}}
                </p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="openClassSelector()" class="bg-primary-600 text-white px-3 py-1 rounded text-sm hover:bg-primary-700 flex items-center mr-2">
                <i class="fas fa-exchange-alt mr-2"></i>
                Switch Class
            </button>
            <button onclick="openLessonSelector()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center">
                <i class="fas fa-clock mr-2"></i>
                Select Lesson
            </button>
            <div class="text-sm text-gray-500">
                Students: <span class="font-medium text-gray-900">{{len .students}}</span>
            </div>
        </div>
    </div>

    <!-- Date Selection -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Date for Attendance</h2>
        <div class="flex items-center space-x-4">
            <div class="flex-1 max-w-xs">
                <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                <input type="date" 
                       id="attendanceDate" 
                       value="{{.today}}"
                       max="{{.today}}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
            </div>
            <div class="flex space-x-2 pt-6">
                <button onclick="takeAttendance()" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-calendar-check mr-2"></i>
                    Take Attendance
                </button>
                <button onclick="viewAttendance()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-eye mr-2"></i>
                    View Attendance
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-check text-green-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Mark All Present</p>
                    <p class="text-xs text-gray-500">Quick action for full attendance</p>
                </div>
            </div>
            <button onclick="markAllPresent()" 
                    class="mt-3 w-full inline-flex items-center justify-center px-3 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Mark All Present
            </button>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-bar text-blue-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Attendance Stats</p>
                    <p class="text-xs text-gray-500">View class statistics</p>
                </div>
            </div>
            <button onclick="viewStats()" 
                    class="mt-3 w-full inline-flex items-center justify-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                View Statistics
            </button>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-download text-purple-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Export Report</p>
                    <p class="text-xs text-gray-500">Download attendance data</p>
                </div>
            </div>
            <button onclick="exportReport()" 
                    class="mt-3 w-full inline-flex items-center justify-center px-3 py-2 border border-purple-300 text-sm font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                Export Report
            </button>
        </div>
    </div>

    <!-- Students List -->
    <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Students in {{.class.Name}}</h2>
            <p class="text-sm text-gray-600 mt-1">{{len .students}} students enrolled</p>
        </div>
        
        <div class="p-6">
            {{if .students}}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {{range .students}}
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 hover:shadow-sm transition-all duration-200">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-gray-600"></i>
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="font-medium text-gray-900">{{.FirstName}} {{.LastName}}</h3>
                                <p class="text-sm text-gray-600">ID: {{.StudentID}}</p>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
            {{else}}
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-graduate text-gray-400 text-xl"></i>
                    </div>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">No Students Found</h3>
                    <p class="mt-2 text-gray-600">No students are enrolled in this class.</p>
                    <div class="mt-6">
                        <a href="/students" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                            <i class="fas fa-plus mr-2"></i>
                            Manage Students
                        </a>
                    </div>
                </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Class Selection Modal -->
<div id="classSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Select Class</h3>
            <button onclick="closeClassSelector()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 max-h-96 overflow-y-auto">
            <div id="classesListModal" class="space-y-2">
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p class="mt-2">Loading classes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Selection Modal -->
<div id="lessonSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Select Lesson</h3>
                <p class="text-sm text-gray-600" id="lessonModalDate">Choose a lesson for attendance</p>
            </div>
            <button onclick="closeLessonSelector()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                <input type="date" id="lessonDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="loadLessonsForDate()">
            </div>
            <div id="lessonsListModal" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-calendar-alt text-2xl mb-2"></i>
                    <p>Select a date to view lessons</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const classId = '{{.class.ID}}';

function takeAttendance() {
    const date = document.getElementById('attendanceDate').value;
    if (!date) {
        alert('Please select a date');
        return;
    }
    window.location.href = `/attendance/class/${classId}/date/${date}`;
}

function viewAttendance() {
    const date = document.getElementById('attendanceDate').value;
    if (!date) {
        alert('Please select a date');
        return;
    }
    // For now, redirect to take attendance page (which shows existing attendance)
    window.location.href = `/attendance/class/${classId}/date/${date}`;
}

async function markAllPresent() {
    const date = document.getElementById('attendanceDate').value;
    if (!date) {
        alert('Please select a date');
        return;
    }

    if (!confirm('Mark all students as present for ' + date + '?')) {
        return;
    }

    try {
        const students = [
            {{range $index, $student := .students}}
            {{if $index}},{{end}}
            {
                id: '{{$student.ID}}',
                student_id: '{{$student.StudentID}}',
                first_name: '{{$student.FirstName}}',
                last_name: '{{$student.LastName}}'
            }
            {{end}}
        ];
        const records = students.map(student => ({
            student_id: student.id,
            status: 'present'
        }));

        const response = await fetch('/api/attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                class_id: classId,
                date: date,
                records: records
            })
        });

        if (response.ok) {
            alert('All students marked as present!');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to mark attendance'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Network error occurred');
    }
}

function viewStats() {
    // This could open a modal or navigate to a stats page
    alert('Attendance statistics - Feature coming soon!');
}

function exportReport() {
    // This could generate and download a report
    alert('Export report - Feature coming soon!');
}

async function openClassSelector() {
    document.getElementById('classSelectorModal').classList.remove('hidden');
    
    try {
        const response = await fetch('/api/classes/');
        const data = await response.json();
        
        if (response.ok) {
            displayClassesInModal(data.classes || []);
        } else {
            displayModalError('Failed to load classes');
        }
    } catch (error) {
        console.error('Error loading classes:', error);
        displayModalError('Network error occurred');
    }
}

function displayClassesInModal(classes) {
    const container = document.getElementById('classesListModal');
    
    if (classes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-school text-2xl mb-2"></i>
                <p>No classes available</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = classes.map(cls => `
        <div class="border border-gray-200 rounded-lg p-3 hover:border-primary-300 hover:bg-gray-50 cursor-pointer transition-all" 
             onclick="selectClass('${cls.id}')">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-gray-900">${cls.name}</h4>
                    <p class="text-sm text-gray-600">${cls.teacher ? cls.teacher.first_name + ' ' + cls.teacher.last_name : 'No teacher assigned'}</p>
                </div>
                <div class="text-sm text-gray-500">
                    ${cls.student_count || 0} students
                </div>
            </div>
        </div>
    `).join('');
}

function displayModalError(message) {
    document.getElementById('classesListModal').innerHTML = `
        <div class="text-center py-4 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>${message}</p>
        </div>
    `;
}

function selectClass(classId) {
    closeClassSelector();
    window.location.href = `/attendance/class/${classId}`;
}

function closeClassSelector() {
    document.getElementById('classSelectorModal').classList.add('hidden');
}

// Close modal on escape key or outside click
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeClassSelector();
    }
});

document.getElementById('classSelectorModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeClassSelector();
    }
});

function openLessonSelector() {
    document.getElementById('lessonSelectorModal').classList.remove('hidden');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('lessonDate').value = today;
    loadLessonsForDate();
}

async function loadLessonsForDate() {
    const date = document.getElementById('lessonDate').value;
    if (!date) return;
    
    document.getElementById('lessonModalDate').textContent = `Lessons for ${date}`;
    document.getElementById('lessonsListModal').innerHTML = `
        <div class="text-center py-4 text-gray-500">
            <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
            <p>Loading lessons...</p>
        </div>
    `;
    
    try {
        // Convert date to day of week
        const dateObj = new Date(date);
        const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        
        const response = await fetch(`/api/attendance/teacher-lessons/${dayOfWeek}`);
        const data = await response.json();
        
        if (response.ok) {
            displayLessonsInModal(data.timetable_entries || [], date);
        } else {
            displayLessonModalError(data.error || 'Failed to load lessons');
        }
    } catch (error) {
        console.error('Error loading lessons:', error);
        displayLessonModalError('Network error occurred');
    }
}

function displayLessonsInModal(lessons, date) {
    const container = document.getElementById('lessonsListModal');
    
    if (lessons.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-calendar-times text-2xl mb-2"></i>
                <p>No lessons scheduled for ${date}</p>
            </div>
        `;
        return;
    }
    
    // Filter lessons for current class
    const currentClassLessons = lessons.filter(lesson => lesson.class_id === classId);
    
    if (currentClassLessons.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-info-circle text-2xl mb-2"></i>
                <p>No lessons scheduled for this class on ${date}</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = currentClassLessons.map(lesson => `
        <div class="border border-gray-200 rounded-lg p-3 hover:border-primary-300 hover:bg-gray-50 cursor-pointer transition-all" 
             onclick="selectLesson('${lesson.id}', '${date}')">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-gray-900">${lesson.time_slot}</h4>
                    <p class="text-sm text-gray-600">Subject: ${lesson.subject_id}</p>
                </div>
                <div class="text-right">
                    <span class="bg-primary-100 text-primary-800 px-2 py-1 rounded text-xs font-medium">
                        Take Attendance
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

function displayLessonModalError(message) {
    document.getElementById('lessonsListModal').innerHTML = `
        <div class="text-center py-4 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>${message}</p>
        </div>
    `;
}

function selectLesson(timetableEntryId, date) {
    closeLessonSelector();
    const params = new URLSearchParams({
        timetable_entry_id: timetableEntryId,
        date: date
    });
    window.location.href = `/attendance/lesson?${params.toString()}`;
}

function closeLessonSelector() {
    document.getElementById('lessonSelectorModal').classList.add('hidden');
}

// Update escape key handler
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeClassSelector();
        closeLessonSelector();
    }
});

// Add lesson modal click outside handler
document.getElementById('lessonSelectorModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeLessonSelector();
    }
});
</script>
