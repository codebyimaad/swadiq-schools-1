<div class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Attendance Management</h1>
            <p class="text-gray-600 mt-1">Track and manage student attendance</p>
        </div>
        <div class="flex items-center space-x-3">
            <a href="/attendance/timetable" class="bg-primary-600 text-white px-4 py-2 rounded-md text-sm hover:bg-primary-700 flex items-center">
                <i class="fas fa-calendar-alt mr-2"></i>
                Timetable Attendance
            </a>
            <div class="text-sm text-gray-500">
                Today: <span class="font-medium text-gray-900">{{.Today}}</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-school text-blue-600 text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Total Classes</p>
                    <p class="text-lg font-semibold text-blue-600">{{len .classes}}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-check text-green-600 text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Present Today</p>
                    <p class="text-lg font-semibold text-green-600" id="presentCount">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-times text-red-600 text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Absent Today</p>
                    <p class="text-lg font-semibold text-red-600" id="absentCount">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600 text-sm"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">Late Today</p>
                    <p class="text-lg font-semibold text-yellow-600" id="lateCount">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Options -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Class-based Attendance -->
        <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Class Attendance</h2>
                <p class="text-sm text-gray-600 mt-1">Take attendance for entire classes</p>
            </div>
            
            <div class="p-6">
                {{if .classes}}
                    <div class="space-y-3">
                        {{range .classes}}
                        <div class="border border-gray-200 rounded-lg p-3 hover:border-primary-300 hover:shadow-sm transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-medium text-gray-900">{{.Name}}</h3>
                                    {{if .Teacher}}
                                        <p class="text-sm text-gray-600">{{.Teacher.FirstName}} {{.Teacher.LastName}}</p>
                                    {{end}}
                                </div>
                                <a href="/attendance/class/{{.ID}}" class="bg-primary-600 text-white px-3 py-1 rounded text-sm hover:bg-primary-700">
                                    Take Attendance
                                </a>
                            </div>
                        </div>
                        {{end}}
                    </div>
                {{else}}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-school text-2xl mb-2"></i>
                        <p>No classes available</p>
                    </div>
                {{end}}
            </div>
        </div>
        
        <!-- Timetable-based Attendance -->
        <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Lesson Attendance</h2>
                <p class="text-sm text-gray-600 mt-1">Take attendance for scheduled lessons</p>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <!-- Date Selection -->
                    <div>
                        <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">Select Date for Attendance</label>
                        <input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" value="{{.Today}}">
                    </div>
                    
                    <!-- Load Classes Button -->
                    <button onclick="loadClassesForDate()" class="w-full bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i>
                        Select Class from Timetable
                    </button>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-900 mb-2">Quick Actions</h4>
                        <div class="space-y-2">
                            <button onclick="loadTodayLessons()" class="w-full text-left px-3 py-2 border border-gray-200 rounded hover:bg-gray-50 text-sm">
                                <i class="fas fa-play mr-2 text-green-600"></i>
                                Current Lesson
                            </button>
                            <button onclick="loadUpcomingLessons()" class="w-full text-left px-3 py-2 border border-gray-200 rounded hover:bg-gray-50 text-sm">
                                <i class="fas fa-clock mr-2 text-blue-600"></i>
                                Upcoming Lessons
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legacy Classes Grid (hidden by default) -->
    <div class="bg-white rounded-lg border border-gray-200 hidden" id="legacyClassGrid">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Select Class for Attendance</h2>
            <p class="text-sm text-gray-600 mt-1">Choose a class to take or view attendance</p>
        </div>

</div>

<!-- Class Selection Modal -->
<div id="classSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Select Class from Timetable</h3>
                <p class="text-sm text-gray-600 mt-1" id="modalDateText">Classes scheduled for selected date</p>
            </div>
            <button onclick="closeClassModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-96">
            <div id="modalClassesList" class="space-y-3">
                <!-- Classes will be loaded here -->
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading classes...</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button onclick="closeClassModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load student counts for each class
    const studentCountElements = document.querySelectorAll('.student-count');
    studentCountElements.forEach(element => {
        const classId = element.getAttribute('data-class-id');
        loadStudentCount(classId, element);
    });
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('attendanceDate').value = today;
    
    // Modal event listeners
    const modal = document.getElementById('classSelectionModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeClassModal();
        }
    });
    
    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeClassModal();
        }
    });
});

async function loadStudentCount(classId, element) {
    try {
        const response = await fetch(`/api/attendance/class/${classId}`);
        const data = await response.json();
        
        if (response.ok) {
            element.textContent = `${data.count} students`;
        } else {
            element.textContent = '- students';
        }
    } catch (error) {
        console.error('Error loading student count:', error);
        element.textContent = '- students';
    }
}

function viewAttendanceHistory(classId, className) {
    alert(`Attendance history for ${className} - Feature coming soon!`);
}

async function loadClassesForDate() {
    const dateInput = document.getElementById('attendanceDate');
    const selectedDate = dateInput.value;
    
    if (!selectedDate) {
        alert('Please select a date first');
        return;
    }
    
    // Show modal
    document.getElementById('classSelectionModal').classList.remove('hidden');
    document.getElementById('modalDateText').textContent = `Classes scheduled for ${selectedDate}`;
    
    try {
        // Convert date to day of week
        const date = new Date(selectedDate);
        const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        
        // Check if user has admin/head teacher privileges
        const userRoles = {{.user.Roles}};
        const canAccessAllClasses = userRoles && userRoles.some(role => 
            role.name === 'admin' || role.name === 'head_teacher'
        );
        
        // Get lessons for the selected day (all or current user's)
        const endpoint = canAccessAllClasses ? 
            `/api/attendance/all-lessons/${dayOfWeek}` : 
            `/api/attendance/teacher-lessons/${dayOfWeek}`;
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (response.ok) {
            displayClassesInModal(data.timetable_entries || [], selectedDate);
        } else {
            displayModalError(data.error || 'Failed to load classes');
        }
    } catch (error) {
        console.error('Error loading classes:', error);
        displayModalError('Failed to load classes. Please try again.');
    }
}

function displayClassesInModal(lessons, date) {
    const classesList = document.getElementById('modalClassesList');
    
    classesList.innerHTML = '';
    
    if (lessons.length === 0) {
        classesList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-calendar-times text-3xl mb-3"></i>
                <h4 class="font-medium text-gray-900 mb-1">No Classes Scheduled</h4>
                <p class="text-sm">No classes found in your timetable for ${date}</p>
            </div>
        `;
        return;
    }
    
    // Group lessons by class
    const classesByClass = {};
    lessons.forEach(lesson => {
        const classKey = lesson.class_id;
        if (!classesByClass[classKey]) {
            classesByClass[classKey] = [];
        }
        classesByClass[classKey].push(lesson);
    });
    
    // Display classes
    Object.keys(classesByClass).forEach(classId => {
        const classLessons = classesByClass[classId];
        const classCard = document.createElement('div');
        classCard.className = 'border border-gray-200 rounded-lg p-4 hover:border-primary-300 hover:shadow-sm transition-all';
        
        const lessonsHtml = classLessons.map(lesson => `
            <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded mb-2 last:mb-0">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-primary-600 text-xs"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900">${lesson.time_slot}</p>
                        <p class="text-sm text-gray-600">Subject: ${lesson.subject_id}</p>
                    </div>
                </div>
                <button onclick="takeAttendanceForLesson('${lesson.id}', '${date}', ${JSON.stringify(lesson).replace(/'/g, "&apos;")})" 
                        class="bg-primary-600 text-white px-3 py-1 rounded text-sm hover:bg-primary-700">
                    Take Attendance
                </button>
            </div>
        `).join('');
        
        classCard.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h4 class="font-semibold text-gray-900">Class: ${classId}</h4>
                    <p class="text-sm text-gray-600">${classLessons.length} lesson(s) scheduled</p>
                </div>
                <div class="text-right">
                    <button onclick="takeClassAttendance('${classId}', '${date}')" 
                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        <i class="fas fa-users mr-1"></i>
                        Class Attendance
                    </button>
                </div>
            </div>
            <div class="space-y-1">
                ${lessonsHtml}
            </div>
        `;
        
        classesList.appendChild(classCard);
    });
}

function displayModalError(message) {
    const classesList = document.getElementById('modalClassesList');
    classesList.innerHTML = `
        <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
            <h4 class="font-medium text-gray-900 mb-1">Error</h4>
            <p class="text-sm">${message}</p>
        </div>
    `;
}

function closeClassModal() {
    document.getElementById('classSelectionModal').classList.add('hidden');
}

function takeClassAttendance(classId, date) {
    closeClassModal();
    window.location.href = `/attendance/class/${classId}/date/${date}`;
}

// Remove the old displayLessons function as it's replaced by displayClassesInModal

function takeAttendanceForLesson(timetableEntryId, date, lesson) {
    // Redirect to attendance taking page with lesson details
    const params = new URLSearchParams({
        timetable_entry_id: timetableEntryId,
        date: date,
        lesson_info: JSON.stringify(lesson)
    });
    
    window.location.href = `/attendance/lesson?${params.toString()}`;
}

function loadTodayLessons() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('attendanceDate').value = today;
    loadClassesForDate();
}

function loadUpcomingLessons() {
    window.location.href = '/attendance/timetable';
}
</script>
